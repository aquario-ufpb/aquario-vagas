name: Expire old jobs
on:
  schedule:
    - cron: "0 3 * * *" # diÃ¡rio 03:00 UTC
  workflow_dispatch: {}

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Remove expired jobs
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const base = path.join('aquario-vagas','centro-de-informatica');

          const getTodaySaoPaulo = () => {
            const now = new Date();
            const sp = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
            sp.setHours(0, 0, 0, 0);
            return sp;
          };

          const parsePrazo = (s) => {
            if (typeof s !== 'string') return null;
            const parts = s.split('/');
            if (parts.length !== 3) return null;
            const [dia, mes, ano] = parts.map(Number);
            if (!dia || !mes || !ano) return null;
            const d = new Date(ano, mes - 1, dia);
            if (isNaN(d.getTime())) return null;
            d.setHours(0, 0, 0, 0);
            return d;
          };

          const today = getTodaySaoPaulo();
          let removed = 0;

          if (fs.existsSync(base)) {
            for (const f of fs.readdirSync(base)) {
              if (!f.endsWith('.json')) continue;
              const p = path.join(base, f);
              try {
                const data = JSON.parse(fs.readFileSync(p,'utf8'));
                const prazo = parsePrazo(data.prazo);
                if (prazo && prazo < today) {
                  fs.unlinkSync(p);
                  removed++;
                  console.log('Removed expired:', f);
                }
              } catch (e) {
                console.warn('Skip invalid JSON:', f);
              }
            }
          }

          if (removed === 0) {
            console.log('No expired jobs');
            process.exit(0);
          }
          "
      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: remove expired jobs"
            git push
          else
            echo "No changes to commit"
          fi

